#!/bin/bash
# Script de gestion VPN - Connexion multi-VPN via openfortivpn
# Configuration dans ~/.vpn/vpns.conf (format INI)
# Usage: vpn [connect|disconnect|status|list|configure|help]

set -o pipefail

# === Déterminer le chemin du script ===
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# === Charger les modules ===
source "$LIB_DIR/core.sh"      # Variables, couleurs, utilitaires
source "$LIB_DIR/config.sh"    # Parseur INI
source "$LIB_DIR/session.sh"   # Gestion des sessions
source "$LIB_DIR/status.sh"    # Statut et détection
source "$LIB_DIR/disconnect.sh" # Déconnexion
source "$LIB_DIR/connect.sh"   # Connexion
source "$LIB_DIR/configure.sh" # Configurateur
source "$LIB_DIR/ui.sh"        # Menu et aide

# === Point d'entrée ===

# Charger la configuration au démarrage
load_config

case "${1:-menu}" in
    connect|c)
        connect "$2"
        ;;
    disconnect|d|stop)
        disconnect "$2"
        ;;
    status|s)
        check_status
        ;;
    list|l)
        list_vpns
        ;;
    configure|config)
        configure_vpn
        ;;
    menu|m|"")
        while true; do
            show_menu
        done
        ;;
    help|h|-h|--help)
        show_help
        ;;
    *)
        log "❌ Commande inconnue: $1" "$RED"
        echo "Utilisez 'vpn help' pour l'aide"
        ;;
esac
